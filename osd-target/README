Documentation for OSD Target library.

Copyright (C) 2007 Dennis Dalessandro (dennis@osc.edu)
Copyright (C) 2007 Ananth Devulapalli (ananth@osc.edu)
Copyright (C) 2007 Pete Wyckoff (pw@osc.edu)

This directory contains code to build an OSD command processor that uses
SQLite as its attribute storage, and a normal file system (such as ext3)
as its data storage.  It is purely userspace code.  It needs one other
major component, namely the SCSI transport and processing.  This is
provided by stgt, and this OSD Target code is a library that is linked
into stgt's executable.

Major components:

    cdb.c - Main entry point via osdemu_cmd_submit, and parsing for
	all commands and optional setattr and getattr CDB sections
    osd.c - One function for every command, plus some helpers.

    obj.c - Object table manipulation
    attr.c - Attribute manipulation back-end

    coll.c - Collection manipulation
    db.c - SQLite database open, close, query, error handling

    list-entry.c - Pack attributes in list format, used in a few places.
    mtq.c - Multitable queries, whenever more than one table is
	searched
    osd.schema - The schema used to initialize the SQLite database,
	converted into a C file during the build process.
    osd-sense.c - Generating sense (error) return values.

    patch/ - Changes to tgt to allow it to use this osd target library.


Building
--------

This requires the osd-util library, and expects it to be in ../osd-util/
by default.  Edit $(UTILDIR) in the Makefile if not.

Type "make" to build the osd target library, libosdtgt.a.

If you have a file called ../Makedefs, it will be used during
the build to set variables in make.  A couple of useful lines to
put in that file are:
    OPT := -g
or
    OPT := -O3 -DNDEBUG


Building a SCSI target
----------------------

To build a full iSCSI target that uses OSD, you'll need to get
the tgt code from its git repository, patch it, then build it
to link against this OSD target library.

The tgt git repository is:

    git://git.kernel.org/pub/scm/linux/kernel/git/tomo/tgt.git

It is browseable at:

    http://git.kernel.org/?p=linux/kernel/git/tomo/tgt.git

This library has been tested with commit
448fe4bd7a8fce622f9efab05a3251a297a1a815 from 13 Dec 2007.

0.  Assuming you will put all of osd-target, osd-util, and tgt in one
    directory, else adjust paths.

1.  Set up for debugging (optional)

    echo "OPT := -g" > Makedefs

2.  Build osd-util

    cd osd-util
    make
    cd ..

3.  Build osd-target

    cd osd-target
    make
    cd ..

4.  Download tgt.

    git clone git://git.kernel.org/pub/scm/linux/kernel/git/tomo/tgt.git

5.  Merge handy patches for OSD support from OSC.  These will use the
    library in osd-target

    cd tgt
    git remote add osc git://git.osc.edu/tgt.git
    git remote update
    git merge osc/local
    cd usr
    make


Running tgt with OSD target
---------------------------

The patches you applied above build the target with OSD support.  They
also make a few changes to tgt to make it easier to deal with for
testing scenarios.

It will create or reuse a directory /tmp/tgt-$(id -un) where
$(id -un) is your username.  It sends logging to stderr, not
to syslog.  A convenient way to run it is:

    ./tgtd -d 9 -f

If you prefer to run it in the background, do not use -f.
If you prefer no debugging messages, do not use -d 9.
You can redirect debug output to a file too.

Now, point an iSCSI initiator at this machine, port 3260, and
issue OSD commands.


# vim: set tw=72 :
